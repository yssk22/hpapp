# auth サービス

auth サービスは hpapp の認証基盤となるサービスです。 hpapp では 3 つの種類の認証を実装しています。

- クライアント認証
- サードパーティユーザー認証
- アプリユーザー認証

## クライアント認証

Client 認証は、リクエストの発行元クライアントを認証するもので不正なクライアントからのアクセスを防止する目的で利用可能です。
この認証ではリクエストヘッダーの特定の項目が認証基盤で認証できた場合にそのクライアント情報をコンテキストに埋め込むミドルウェアを提供します。

1. `x-hpapp-client-authorization: bearer {token}` ヘッダーに Firebase の AppCheck トークンが埋め込まれているとき
2. `x-hpapp-client-authorization: bearer {token}` ヘッダーに `service.auth.client.system_token` のトークンが埋め込まれているとき
3. `authorization: bearer {token}` ヘッダーに Goocle Cloud のサービスユーザーのトークンが埋め込まれているとき

いずれも各サービスからは `client.CurrentClient(ctx)` を使って取得できます。リクエストがクライアントを認証できなかった場合 `client.CurrentClient(ctx).IsVerified(ctx)` が false になります。3. のケースは特殊で Google Cloud 環境内でシステム間通信を行うときに利用されます。例えば Cloud Scheduler から Cloud Run へのリクエストなどで、OIDC トークンを設定する場合 Authorization ヘッダーにトークンが埋め込まれ、これはサービスアカウントからのリクエストであることを示します。サービスアカウントは通常のアプリユーザーとは異なるので Client として認識されます。

## サードパーティユーザー認証

サードパーティユーザー認証は、リクエストの発行元ユーザーを認証するもので hpapp に**登録前のアプリユーザー**を特定する目的で利用可能です。また、ユーザーがサードパーティに関連するオペレーションを行うときに、この認証を用いて必要なトークンを取得することができます。この認証では `X-hpapp-3p-authorization: bearer {token}` が認証できた場合に、そのユーザー情報をコンテキストに埋め込むミドルウェアを提供します。

各サービスからは `extuser.CurrentClient(ctx)` を使って取得できます。この関数が nil となるときは、ユーザーはサードパーティ認証情報を付与していないことを意味しますが、各サービスは、サードパーティ認証情報が必要でない場合は無視して問題ありません。

## アプリユーザー認証

アプリユーザー認証は、リクエストの発行元ユーザーを認証するもので登録済みのアプリユーザーを特定する目的で利用可能です。 この認証では `Authorization: bearer {token}` が認証できた場合に、そのユーザー情報をコンテキストに埋め込むミドルウェアを提供します。

各サービスからは `appuser.CurrentUser(ctx)` を使って取得できます。この関数は必ず appuser.User インターフェースをもつオブジェクトを返します。
